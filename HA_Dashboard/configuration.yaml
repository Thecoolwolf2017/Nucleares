# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

lovelace:
  mode: storage
  dashboards:
    nucleares-dashboard:
      mode: yaml
      title: Nucleares
      icon: mdi:atom
      show_in_sidebar: true
      filename: dashboard.yaml

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

history:

recorder:
  exclude:
    entities:
      - sensor.ws
      - sensor.valve_panel_json_1
      - sensor.valve_panel_json_2
      - sensor.weather_forecast_json
      - sensor.installed_loops_json

homeassistant:
  auth_providers:
    - type: trusted_networks
      trusted_networks:
        - 127.0.0.1
      trusted_users:
        127.0.0.1: !secret nucleares_trusted_user_id
      allow_bypass_login: true
    - type: homeassistant

rest_command:
  nucleares_webserver_set:
    url: !secret nucleares_backend_commands_url
    method: POST
    headers:
      content-type: application/json
      X-Command-Token: !secret nucleares_command_token
    payload: >
      {{ {
        "purpose": ("HA set " ~ var)[:200],
        "tasks": [
          {
            "operation": "set",
            "variable": var,
            "value": val
          }
        ],
        "metadata": {
          "source": "home_assistant",
          "requested_at": now().isoformat(),
          "context_id": context.id if context is defined else None
        }
      } | tojson }}

sensor:
  - platform: rest
    name: ws
    resource: !secret nucleares_backend_state_url
    method: GET
    scan_interval: 2
    value_template: "{{ value_json.last_updated | default('Unavailable') }}"
    json_attributes:
      - data
      - pagination
  - platform: rest
    name: INSTALLED_LOOPS_JSON
    resource: !secret nucleares_installed_loops_url
    method: GET
    scan_interval: 10
    value_template: "{{ value_json.last_updated | default('Unavailable') }}"
    json_attributes:
      - data
  - platform: rest
    name: VALVE_PANEL_JSON_1
    resource: !secret nucleares_valve_panel_url
    method: GET
    scan_interval: 1
    value_template: "{{ value_json.last_updated | default('Unavailable') }}"
    json_attributes:
      - data
  - platform: rest
    name: VALVE_PANEL_JSON_2
    resource: !secret nucleares_valve_panel_url
    method: GET
    scan_interval: 1
    value_template: "{{ value_json.last_updated | default('Unavailable') }}"
    json_attributes:
      - data
  - platform: rest
    name: WEATHER_FORECAST_JSON
    resource: !secret nucleares_weather_forecast_url
    method: GET
    scan_interval: 1
    value_template: "{{ value_json.last_updated | default('Unavailable') }}"
    json_attributes:
      - data


template: !include template_sensors.yaml

panel_custom:
  - name: logs
    sidebar_title: Logs
    sidebar_icon: mdi:post
    js_url: /api/hassio/app/entrypoint.js
    url_path: "config/logs"
    embed_iframe: true
    require_admin: true
    config:
      ingress: core_configurator
  - name: automations
    sidebar_title: Automations
    sidebar_icon: mdi:arrow-decision
    js_url: /api/hassio/app/entrypoint.js
    url_path: "config/automation/dashboard"
    embed_iframe: true
    require_admin: true
    config:
      ingress: core_configurator
  - name: integrations
    sidebar_title: Integrations
    sidebar_icon: mdi:chip
    js_url: /api/hassio/app/entrypoint.js
    url_path: "config/integrations/dashboard"
    embed_iframe: true
    require_admin: true
    config:
      ingress: core_configurator
  - name: server_control
    sidebar_title: Server Control
    sidebar_icon: mdi:cog-transfer
    js_url: /api/hassio/app/entrypoint.js
    url_path: "developer-tools/yaml"
    embed_iframe: true
    require_admin: true
    config:
      ingress: core_configurator
  - name: Helpers
    sidebar_title: Helpers
    sidebar_icon: mdi:handshake
    js_url: /api/hassio/app/entrypoint.js
    url_path: "config/helpers"
    embed_iframe: true
    require_admin: true
    config:
      ingress: core_configurator

# Added By Homeway to enable Alexa support.
alexa:
  smart_home:

# Added By Homeway to enable Google Assistant support.
# google_assistant:
#   project_id: homewayio
#   service_account:
#     private_key: "nokey"
#     client_email: "support@homeway.io"
