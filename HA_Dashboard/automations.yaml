- id: '1745383146738'
  alias: Demand Following
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.power_demand_mw
  - trigger: state
    entity_id:
    - sensor.total_power_output_mw
  conditions:
  - condition: numeric_state
    entity_id: sensor.power_demand_mw
    above: 0
  - condition: numeric_state
    entity_id: sensor.total_power_output_mw
    above: 0
  actions:
  - variables:
      loop: "{{ states('input_select.loop') | string }}"
      demand_delta: "{{ states('sensor.demand_delta') | float(0) }}"
      delta_sign: "{{ 1 if (states('sensor.demand_delta') | float(0)) > 0 else (-1 if (states('sensor.demand_delta') | float(0)) < 0 else 0) }}"
      flow_ratio: >-
        {% set sec_speed = states('sensor.coolant_sec_circulation_pump' ~ loop ~ 'speed') | float(0) %}
        {% set sec_capacity = states('sensor.coolant_sec_circulation_pump' ~ loop ~ 'capacity') | float(0) %}
        {% set pri_speed = states('sensor.coolant_core_circulation_pump' ~ loop ~ 'speed') | float(0) %}
        {% set pri_capacity = states('sensor.coolant_core_circulation_pump' ~ loop ~ 'capacity') | float(0) %}
        {% set secondary_flow = (sec_speed / 100) * sec_capacity %}
        {% set primary_flow = (pri_speed / 100) * pri_capacity %}
        {% set denominator = primary_flow if primary_flow | abs > 0 else 1 %}
        {{ (secondary_flow / denominator) | float }}
      game_speed: "{{ [states('sensor.game_sim_speed') | float(1), 0.1] | max }}"
  - if:
    - condition: or
      conditions:
      - condition: numeric_state
        entity_id: sensor.total_power_output_mw
        below: sensor.demand_lowerlimit
      - condition: numeric_state
        entity_id: sensor.total_power_output_mw
        above: sensor.demand_upperlimit
      alias: Power Output not within Demand Limits
    then:
    - alias: Adjust Primary-only or Steam Valve and all pumps
      if:
      - condition: numeric_state
        entity_id: sensor.demand_delta
        above: -6
        below: 6
      - alias: Sec/Pri Flow Ratio is within bounds
        condition: template
        value_template: "{{ (demand_delta > 0 and (flow_ratio | float(0)) >= 3.0)
          or (demand_delta < 0 and (flow_ratio | float(0)) <= 4.0) }}"
        enabled: true
      then:
      - action: rest_command.nucleares_webserver_set
        data:
          var: COOLANT_CORE_CIRCULATION_PUMP{{loop}}ORDERED_SPEED
          val: >-
            {% set current = states('sensor.coolant_core_circulation_pump' ~ loop ~ 'speed') | float(0) %}
            {% set updated = current + delta_sign %}
            {{ [0, [100, updated] | min] | max | round(0) | int }}
        alias: Adjust Primary Pump Speed +/- 1
      - delay:
          hours: 0
          minutes: 0
          seconds: "{{ [1, ((3 / game_speed) | round(0) | int)] | max }}"
          milliseconds: 0
        alias: Wait for (3 / simspeed) seconds
      - alias: NOTIFICATION
        action: persistent_notification.create
        data:
          message: "Demand: {{ states('sensor.power_demand_mw') }} <br> Output: {{
            states('sensor.total_power_output_mw') | float(0) }} <br> Delta = {{
            demand_delta | round(2) }} <br><br> Loop: {{ loop }} ==> PRIMARY PUMP
            speed adjustment <br> Primary = {{ states('sensor.coolant_core_circulation_pump'
            ~ loop ~ 'speed') | float(0) }}% -> {{ (states('sensor.coolant_core_circulation_pump'
            ~ loop ~ 'speed') | float(0) / 100 * states('sensor.coolant_core_circulation_pump'
            ~ loop ~ 'capacity') | float(0)) | round(1) }} L/m of {{ states('sensor.coolant_core_circulation_pump'
            ~ loop ~ 'capacity') | float(0) }} L/m <br> Secondary = {{ states('sensor.coolant_sec_circulation_pump'
            ~ loop ~ 'speed') | float(0) }}% -> {{ (states('sensor.coolant_sec_circulation_pump'
            ~ loop ~ 'speed') | float(0) / 100 * states('sensor.coolant_sec_circulation_pump'
            ~ loop ~ 'capacity') | float(0)) | round(1) }} L/m of {{ states('sensor.coolant_sec_circulation_pump'
            ~ loop ~ 'capacity') | float(0) }} L/m <br> MSCV = {{ states('sensor.mscv'
            ~ loop ~ 'opening_actual') | float(0) }}% <br> Flow Ratio = {{
            flow_ratio | float(0) | round(3) }} <br> New Primary Pump speed setpoint:
            {{ [0, [100, (states('sensor.coolant_core_circulation_pump' ~ loop ~ 'speed')
            | float(0) + delta_sign)] | min] | max | round(0) | int }}%"
          notification_id: PrimaryPump
        enabled: true
      else:
      - variables:
          target_mscv: >-
            {% set current = states('sensor.mscv' ~ loop ~ 'opening_actual') | float(0) %}
            {% set raw_target = current + (demand_delta / 6) %}
            {{ [2, [40, raw_target] | min] | max | round(1) }}
        alias: target MSCV = current mscv +  (demand_delta / 6)
      - alias: Match Secondary Pump Speed to Target MSCV
        action: rest_command.nucleares_webserver_set
        data:
          var: COOLANT_SEC_CIRCULATION_PUMP{{loop}}ORDERED_SPEED
          val: >-
            {% set capacity = states('sensor.coolant_sec_circulation_pump' ~ loop ~ 'capacity') | float(0) %}
            {% set denom = capacity if capacity | abs > 0 else 1 %}
            {% set desired = (target_mscv | float(0) * 1000 / denom) %}
            {{ [0, [100, desired] | min] | max | round(1) }}
      - alias: Match Primary Pump Speed to Target MSCV
        action: rest_command.nucleares_webserver_set
        data:
          var: COOLANT_CORE_CIRCULATION_PUMP{{loop}}ORDERED_SPEED
          val: >-
            {% set capacity = states('sensor.coolant_core_circulation_pump' ~ loop ~ 'capacity') | float(0) %}
            {% set denom = capacity if capacity | abs > 0 else 1 %}
            {% set desired = (target_mscv | float(0) * 300 / denom) %}
            {{ [0, [100, desired] | min] | max | round(1) }}
      - alias: If MSCV not at Target, adjust MSCV +/- 1
        if:
        - condition: template
          value_template: '{{ states(''sensor.mscv''+loop+''opening_actual'') | float(0)
            != target_mscv }}'
          alias: Is MSCV not at Target?
        then:
        - action: rest_command.nucleares_webserver_set
          data:
            var: MSCV{{loop}}OPENING_ORDERED
            val: >-
              {% set current = states('sensor.mscv' ~ loop ~ 'opening_actual') | float(0) %}
              {% set updated = current + delta_sign %}
              {{ [2, [40, updated] | min] | max | round(0) | int }}
          alias: Adjust Main Steam Control Valve +/- 1
      - alias: NOTIFICATION
        action: persistent_notification.create
        data:
          message: "Demand: {{ states('sensor.power_demand_mw') }} <br> Output: {{
            states('sensor.total_power_output_mw') }} <br> Delta = {{ states('sensor.demand_delta')
            | round(2) }} <br><br> Loop: {{loop}} ==> STEAM VALVE adjustment  <br>MSCV
            = {{ target_mscv }} <br> New Primary = {{
            ([0, [100, (target_mscv | float(0) * 300 / ([states('sensor.coolant_core_circulation_pump'
            ~ loop ~ 'capacity') | float(0), 1] | max))] | min] | max) | round(1) }}
            <br> New Secondary = {{
            ([0, [100, (target_mscv | float(0) * 1000 / ([states('sensor.coolant_sec_circulation_pump'
            ~ loop ~ 'capacity') | float(0), 1] | max))] | min] | max) | round(1) }}<br>
            Ratio: {{ flow_ratio | float(0) | round(4) }}"
          notification_id: SteamValve
        enabled: true
      - delay:
          hours: 0
          minutes: 0
          seconds: "{{ [1, ((10 / game_speed) | round(0) | int)] | max }}"
          milliseconds: 0
        alias: Wait for (10 / simspeed) seconds
  - delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  mode: single
- id: '1746027130216'
  alias: Core Target Temp
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.core_state_criticality
    - sensor.core_temp
    - sensor.rods_pos_actual
    for:
      hours: 0
      minutes: 0
      seconds: 5
  conditions:
  - condition: numeric_state
    entity_id: sensor.core_state_criticality
    above: -5
    below: 5
  actions:
  - variables:
      tgt_reactivity: '{{ min(((states(''input_number.target_core_temp'') | float
        - states(''sensor.core_temp'') | float)  / states(''input_number.target_core_temp'')
        | float) | round(3) * 10 | float,2) }}'
  - alias: Target ROD Position different than Actual Position
    if:
    - condition: template
      value_template: "{{  (states('sensor.rods_pos_actual') | float + max(states('sensor.core_state_criticality')
        | float - tgt_reactivity,-2)) \n  | float | round(1) != states('sensor.rods_pos_actual')
        | float | round(1) }}\n"
    then:
    - action: notify.persistent_notification
      metadata: {}
      data:
        message: "SET RODS to {{(states('sensor.rods_pos_actual') | float + max(states('sensor.core_state_criticality')
          | float - tgt_reactivity,-2)) \n    | float | round(2) }}"
        data:
          notification_id: rods
    - action: rest_command.nucleares_webserver_set
      data:
        var: RODS_ALL_POS_ORDERED
        val: '{{ states(''sensor.rods_pos_actual'') | float + max(states(''sensor.core_state_criticality'')
          | float - tgt_reactivity,-2) }}'
      alias: Adjust Control Rods
  - delay:
      hours: 0
      minutes: 0
      seconds: '{{ (states(''sensor.core_temp'') | int - states(''input_number.target_core_temp'')
        | int) | abs / 10 / states(''sensor.game_sim_speed'') | int + 1 }}'
      milliseconds: 0
  mode: single
- id: '1746249037975'
  alias: Hourly Timestamp
  description: ''
  triggers:
  - trigger: template
    value_template: '{{ states(''sensor.time'').split(":")[1] | int == 0 }}'
    enabled: true
  conditions: []
  actions:
  - action: input_number.set_value
    metadata: {}
    data:
      value: 10000
    target:
      entity_id:
      - input_number.timestamp
  - action: input_number.set_value
    metadata: {}
    data:
      value: 0
    target:
      entity_id:
      - input_number.timestamp
  mode: single
- id: '1746405000000'
  alias: Loop Flow Ratio Guard
  description: Focuses the active loop and alerts when the secondary/primary flow ratio leaves the safe band.
  triggers:
  - trigger: state
    entity_id:
    - sensor.loop0_flowratio
    - sensor.loop1_flowratio
    - sensor.loop2_flowratio
    for:
      hours: 0
      minutes: 0
      seconds: 10
  conditions:
  - condition: template
    value_template: >-
      {% set ratio = trigger.to_state.state | float(0) %}
      {{ ratio < 3.0 or ratio > 4.0 }}
  actions:
  - variables:
      loop_number: "{{ trigger.entity_id | regex_findall_index('loop(\\d)_flowratio')
        | default('0') }}"
      loop_option: "{{ '_' ~ loop_number ~ '_' }}"
      ratio: "{{ trigger.to_state.state | float(0) }}"
      direction: "{{ 'below' if ratio < 3 else 'above' }}"
  - alias: Highlight affected loop on dashboards
    action: input_select.select_option
    target:
      entity_id: input_select.loop
    data:
      option: '{{ loop_option }}'
  - alias: Persist notification
    action: persistent_notification.create
    data:
      title: Loop {{ loop_number }} flow alert
      message: |-
        Coolant Loop {{ loop_number }} secondary/primary flow ratio has been {{ direction }} the safe range (3.0 - 4.0) for at least 10 seconds.

        Current ratio: {{ ratio | round(3) }}

        Secondary flow: {{ states('sensor.coolant_sec_circulation_pump_' ~ loop_number ~ '_speed')
        | float(0) }}% of {{ states('sensor.coolant_sec_circulation_pump_' ~ loop_number ~ '_capacity')
        | float(0) }} L/m

        Primary flow: {{ states('sensor.coolant_core_circulation_pump_' ~ loop_number ~ '_speed')
        | float(0) }}% of {{ states('sensor.coolant_core_circulation_pump_' ~ loop_number ~ '_capacity')
        | float(0) }} L/m

        Confirm pump status and valve positions, then re-run demand following if needed.
      notification_id: LoopFlowGuard
  mode: restart
